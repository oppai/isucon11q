# ISUCON11予選
今年は例年のメンバーが揃わなくて一人で参加しました。
毎年予選落ちなんですが参加するたびにちょっとずつできることが増えてきて良いなと実感してます。

<img width="662" alt="スクリーンショット 2021-08-21 18 53 35" src="https://user-images.githubusercontent.com/1712116/130327215-57d76647-51a5-46a1-ae07-085732717c8f.png">

終始サーバーリソースがスカスカでCPUやメモリに余裕があった。
deductionが全然上がらなかったりアプリケーション側の修正に時間を使いすぎた。
NewRelicはnetdata代わりに使った、インラインプラファイラとしても使おうと思ったけど上手く読み込んでくれなかった。
アプリケーションはGo固定にして余裕があったらイジる程度にしていたが正解だったかも。

#### やったこと
1. NewRelicのインストール
1. slow query logの設定
1. alpの準備(nginx/access.logの整形)
1. GoのAMPの設定
  1. Go全然触ったことなくてEchoのミドルウェアとして追加できるのに気がつくのに時間がかかった
1. ベンチ走らせつつアプリケーションを読み始める (11時過ぎ)
1. isu_conditionにindex追加 (1600 -> 13892)
1. お昼ごはん (12時)
1. isu にもindex追加 (13892 -> 15784)
1. 画像をDBに突っ込んでるのを発見してこれを外だし頑張るもベンチが落ちまくる (13-15時)
1. assets をnginx配信 / iconをファイルに変更 (15784 -> 15230) (16時)
  1. 画像配信にも認証がありそこでコケているのに気がつき無意味なことに途方に暮れる
1. 複数台構成に変更 (15230 -> 30560) (16時)
  1. 正直1台でも全然リソース使ってなかったのでApp2, DB1という構成にする
  1. replicationするほど時間に余裕なかったのとDBに負荷がないのでリクエストにリソース回せるかなと思った
1. deductionが低く負荷が来ないのでベンチの挙動やアプリケーションの仕様を眺める
1. trendが遅くて負荷が来てないのかと推測する (17時)
1. character をindexに追加, trend分散 (30560 -> ??? 同じくらい)
1. とりあえずログやミドルウェアを止める (30560 -> 35000前後)
1. 全台再起動テスト (17時半)
1. publicをキャッシュしてないのに気がつく(18時)
  1. publicのnginxキャッシュ / trendのキャッシュ (30560 -> 47795, deuction 2 -> 60)
  1. ここでやっとConnectionエラーが頻発するもののミドルウェアを止めていたのでどこが詰まってるかわからず
1. 適当にnginxやsystemdでaccept数やulimitを上げるがベンチは変わらず (18時)
1. 特に新しいことはできず終わり (19時)

#### やりたかったこと
- コネクションが失敗している理由の言及 (ログ周りはギリギリまで残しても良かったかも)
- APP3台の方が実は良かった？ (SSL展開分散も)
- `X-Accel-Redirect` は思い付かなかった、便利そう
- NewRelicによるインラインプロファイル

#### 総括
終始サーバーリソースがスカスカでCPUやメモリに余裕があった。　　
deductionが全然上がらなかったりアプリケーション側の修正に時間を使いすぎた。　　
NewRelicはnetdata代わりに使った、インラインプラファイラとしても使おうと思ったけど上手く読み込んでくれなかった。　　
今回一人だったのでアプリケーションはGo固定にして余裕があったらイジる程度にしていたが正解だったかも.  
ただ沼にハマると一人は辛い…、fdが枯渇してこれからや！！って時に終わったので消化不良。  
次はこの段階に早いところまで持っていきたい。  
